{% extends "base.html" %}
{% block content %}
  <h2>Dashboard</h2>
  <p>Welcome, {{ current_user.name }}! Here are your productivity stats:</p>

  {# Container to hold data for JS #}
  <div id="dashboard-data"
       data-total-focus="{{ total_focus }}"
       data-total-break="{{ total_break }}"
       data-total-sessions="{{ total_sessions }}">

    <ul class="stats">
      <li><strong>Total Focused Time:</strong> {{ total_focus }} minutes</li>
      <li><strong>Total Break Time:</strong> {{ total_break }} minutes</li>
      <li><strong>Completed Pomodoro Sessions:</strong> {{ total_sessions }}</li>
    </ul>

  </div> {# End of dashboard-data #}


  <h3>Past Sessions</h3>
  {% if sessions %}
    {# ADDED Scrollable Container #}
    <div class="sessions-table-container">
      <table class="sessions-table">
        <thead> {# Added thead for structure #}
          <tr><th>Date & Time (Your Local)</th><th>Work (min)</th><th>Break (min)</th></tr>
        </thead>
        <tbody> {# Added tbody for structure #}
          {% for sess in sessions %}
            <tr>
              {# Pass UTC timestamp via data attribute for JS formatting #}
              <td class="local-timestamp" data-timestamp="{{ sess.timestamp.isoformat() if sess.timestamp else '' }}">
                 {# Initial display (JS will replace this) #}
                 {% if sess.timestamp %}{{ sess.timestamp.isoformat() }}{% else %}N/A{% endif %}
              </td>
              <td>{{ sess.work_duration }}</td>
              <td>{{ sess.break_duration }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div> {# END of sessions-table-container #}
  {% else %}
    <p>No sessions recorded yet. <a href="{{ url_for('main.timer') }}">Start your first Pomodoro!</a></p>
  {% endif %}

  {# +++ Chat Agent Section +++ #}
  {% if chat_enabled %}
  <div class="chat-agent-section">
    <h3>Productivity Assistant</h3>
    <p>Ask questions about your stats or get productivity tips!</p>
    <div id="chat-log" class="chat-log">
      {# Chat messages will appear here via JS #}
      <div class="message ai">Hello {{ current_user.name }}! How can I help you analyze your Pomodoro stats or improve your focus today?</div>
    </div>
    <div class="chat-input-area">
      <input type="text" id="chat-input" placeholder="Type your message..." aria-label="Chat message input">
      <button id="chat-send-btn" class="btn">Send</button>
    </div>
    <div id="chat-status" class="chat-status" aria-live="polite"></div> {# For loading/error messages #}
  </div>
  {% else %}
  <div class="chat-agent-section disabled">
      <h3>Productivity Assistant</h3>
      <p><i>Chat feature is currently unavailable. Please check server configuration (OpenAI key).</i></p>
  </div>
  {% endif %}
  {# +++ End Chat Agent Section +++ #}


  {# +++ NEW Inline Script to Pass Data to dashboard.js +++ #}
  {# Place this *before* linking the external dashboard.js file #}
  <script>
    window.dashboardConfig = {
      // Pass the chat enabled status (as true/false)
      chatEnabled: {{ chat_enabled | tojson }},
      // Pass the URL for the chat API endpoint
      apiChatUrl: "{{ url_for('main.api_chat') }}"
      // Add any other data needed by dashboard.js here in the future
    };
  </script>

  {# +++ Link the External JavaScript File +++ #}
  {# Removed the large inline script block #}
  <script src="{{ url_for('static', filename='js/dashboard.js') }}" defer></script>

{% endblock %}