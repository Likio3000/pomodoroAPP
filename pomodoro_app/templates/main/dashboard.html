{% extends "base.html" %}
{% block content %}
  <h2 class="dashboard-main-title">Dashboard</h2>
  <p>Welcome, {{ current_user.name }}! Here are your productivity stats:</p>

  {# Container to hold data attributes for JS timestamp formatting #}
  {# This div is NO LONGER used for passing chat data #}
  <div id="dashboard-data"
       data-total-focus="{{ total_focus }}"
       data-total-break="{{ total_break }}"
       data-total-sessions="{{ total_sessions }}"
       data-today-focus="{{ today_focus }}"
       data-today-sessions="{{ today_sessions }}"
       data-week-focus="{{ week_focus }}"
       data-week-sessions="{{ week_sessions }}"
       >
    {# No visual content here #}
  </div>

  {# Stats Columns (structure remains the same) #}
  <div class="stats-columns-container">
    {# Column 1: Overall Stats #}
    <div class="stats-column">
      <h3 class="dashboard-section-title">Overall Stats</h3>
      <ul class="stats">
        <li><strong>Total Focused Time:</strong> {{ total_focus }} minutes</li>
        <li><strong>Total Break Time:</strong> {{ total_break }} minutes</li>
        <li><strong>Completed Pomodoro Sessions:</strong> {{ total_sessions }}</li>
        <li><strong>Total Points Earned:</strong> {{ current_user.total_points | int }}</li> {# Display total points #}
      </ul>
    </div> {# End stats-column (Overall) #}

    {# Column 2: Today's Stats #}
    <div class="stats-column">
      <h3 class="dashboard-section-title">Today's Stats (UTC)</h3>
      <ul class="stats">
        <li><strong>Focused Time Today:</strong> {{ today_focus }} minutes</li>
        <li><strong>Sessions Today:</strong> {{ today_sessions }}</li>
      </ul>
    </div> {# End stats-column (Today) #}

    {# Column 3: Week's Stats #}
    <div class="stats-column">
      <h3 class="dashboard-section-title">This Week's Stats (UTC)</h3>
       <ul class="stats">
        <li><strong>Focused Time This Week:</strong> {{ week_focus }} minutes</li>
        <li><strong>Sessions This Week:</strong> {{ week_sessions }}</li>
      </ul>
    </div> {# End stats-column (Week) #}
  </div> {# End stats-columns-container #}


  {# Past Sessions Section (structure remains the same) #}
  <h3 class="dashboard-section-title">Past Sessions</h3> {# Applied consistent title style #}
  {% if sessions %}
    <div class="sessions-table-container">
      <table class="sessions-table">
        <thead>
          <tr><th>Date & Time (Your Local)</th><th>Work (min)</th><th>Break (min)</th><th>Points</th></tr>
        </thead>
        <tbody>
          {% for sess in sessions %}
            <tr>
              <td class="local-timestamp" data-timestamp="{{ sess.timestamp.isoformat() if sess.timestamp else '' }}">
                 {% if sess.timestamp %}{{ sess.timestamp.isoformat() }}{% else %}N/A{% endif %}
              </td>
              <td>{{ sess.work_duration }}</td>
              <td>{{ sess.break_duration }}</td>
              <td>{{ sess.points_earned if sess.points_earned is not none else '--' }}</td> {# Show points earned for that session #}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p>No sessions recorded yet. <a href="{{ url_for('main.timer') }}">Start your first Pomodoro!</a></p>
  {% endif %}

  {# --- Removed Embedded Chat Agent Section --- #}
  {# The floating widget from agent_chat.js will be used instead #}

  {# +++ Load Libraries for Floating Chat Widget +++ #}
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>

  {# +++ Load the Floating Agent Chat Widget +++ #}
  <script>
    // Optional: Pass global config needed by agent_chat.js if necessary
    // Example: Setting initial TTS toggle state based on server config
    window.dashboardConfig = { // Rename or use a generic name like window.pageConfig
        ttsGloballyEnabled: {{ config.get('TTS_ENABLED', true) | tojson }}
        // Add other config data if agent_chat.js needs it
    };
  </script>
  <script src="{{ url_for('static', filename='js/agent_chat.js') }}" defer></script>

  {# +++ Load Dashboard Specific JS (for timestamp formatting) +++ #}
  <script src="{{ url_for('static', filename='js/dashboard.js') }}" defer></script>

{% endblock %}