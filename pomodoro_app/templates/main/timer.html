<!-- pomodoro_app/templates/main/timer.html -->
{% extends "base.html" %}
{% block content %}
  <h2>Start a Pomodoro Session</h2>
  <div class="timer-setup">
    <label>Work: <input id="work-minutes" type="number" value="25" min="1"> minutes</label>
    <label>Break: <input id="break-minutes" type="number" value="5" min="1"> minutes</label>
    <button id="start-btn" class="btn">Start</button>
  </div>
  <div id="timer-display" class="timer-display"></div>
  <div id="status-message" class="status-message"></div>
  
  <!-- Audio element for alarm -->
  <audio id="alarm-sound" src="{{ url_for('static', filename='alarm.mp3') }}" preload="auto"></audio>
  
  <script>
    let workMinutes = 0;
    let breakMinutes = 0;
    let breakSeconds = 0;
    let timerInterval = null;
    
    function formatTime(seconds) {
      const m = Math.floor(seconds / 60);
      const s = seconds % 60;
      return String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');
    }
    
    function updateDisplay(seconds, phase) {
      const display = document.getElementById('timer-display');
      const label = phase === 'work' ? 'Work' : 'Break';
      display.textContent = label + " Time: " + formatTime(seconds);
    }
    
    function startTimer(duration, phase) {
      if (timerInterval) clearInterval(timerInterval);
      let remaining = duration;
      updateDisplay(remaining, phase);
      timerInterval = setInterval(function() {
        remaining--;
        if (remaining >= 0) {
          updateDisplay(remaining, phase);
        }
        if (remaining < 0) {
          clearInterval(timerInterval);
          const alarm = document.getElementById('alarm-sound');
          if (alarm) alarm.play();
          if (phase === 'work') {
            document.getElementById('status-message').textContent = "Work session complete! Break time begins.";
            setTimeout(function() {
              document.getElementById('status-message').textContent = "";
              startTimer(breakSeconds, 'break');
            }, 1000);
          } else {
            document.getElementById('status-message').textContent = "Break over! Pomodoro session completed.";
            // Log the session and clear the active timer flag
            logSession(workMinutes, breakMinutes);
          }
        }
      }, 1000);
    }
    
    function logSession(work, brk) {
      fetch("{{ url_for('main.complete_session') }}", {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ work: work, break: brk })
      }).then(response => {
        if (!response.ok) {
          console.error("Failed to log session");
        }
      }).catch(err => {
        console.error("Error logging session:", err);
      });
    }
    
    document.getElementById('start-btn').addEventListener('click', function() {
      workMinutes = parseInt(document.getElementById('work-minutes').value) || 0;
      breakMinutes = parseInt(document.getElementById('break-minutes').value) || 0;
      if (workMinutes <= 0 || breakMinutes <= 0) {
        alert("Please enter valid durations for work and break.");
        return;
      }
      breakSeconds = breakMinutes * 60;
      const workSeconds = workMinutes * 60;
      // Set the active timer flag by calling the new endpoint with an Accept header for HTML
      fetch("{{ url_for('main.start_timer') }}", { 
        method: 'POST',
        headers: { 'Accept': 'text/html' }
      })
      .then(response => {
        if (response.status === 429) {
          alert("Too many requests. Please try again later.");
        } else if (response.ok) {
          document.getElementById('status-message').textContent = "";
          startTimer(workSeconds, 'work');
        } else {
          console.error("Failed to set active timer flag");
        }
      })
      .catch(err => console.error("Error setting active timer flag:", err));
    });
  </script>
{% endblock %}
